## template: jinja
#cloud-config
hostname: ${hostname}
package_update: true
package_upgrade: true
package_reboot_if_required: true
write_files:
- path: /etc/sysctl.d/10-ip-forwarding.conf
  content: |
    net.ipv4.ip_forward=1
- path: /etc/iptables/rules.v4
  content: |
    # Generated by iptables-save v1.8.4 on Tue Aug 24 19:16:37 2021
    *filter
    :INPUT ACCEPT [0:0]
    :FORWARD ACCEPT [0:0]
    :OUTPUT ACCEPT [0:0]
    COMMIT
    # Completed on Tue Aug 24 19:16:37 2021
    # Generated by iptables-save v1.8.4 on Tue Aug 24 19:16:37 2021
    *nat
    :PREROUTING ACCEPT [0:0]
    :INPUT ACCEPT [0:0]
    :OUTPUT ACCEPT [0:0]
    :POSTROUTING ACCEPT [0:0]
    -A POSTROUTING -o bond0 -j MASQUERADE
    COMMIT
    # Completed on Tue Aug 24 19:16:37 2021
- path: /etc/iptables/rules.v6
  content: |
    # Generated by ip6tables-save v1.8.4 on Tue Aug 24 19:16:37 2021
    *filter
    :INPUT ACCEPT [0:0]
    :FORWARD ACCEPT [0:0]
    :OUTPUT ACCEPT [0:0]
    COMMIT
- path: /etc/network/interfaces
  append: true
  content: |
    auto bond0.${bastion_vlan_id}
    iface bond0.${bastion_vlan_id} inet static
        pre-up sleep 5
        address ${address}
        netmask ${netmask}
        vlan-raw-device bond0
- path: /etc/dnsmasq.d/vcf.config
  append: true
  content: |
    bind-interfaces
    interface=bond0.${bastion_vlan_id}
    host-record=${esx01_name}.${zone_name},${esx01_ip}
    host-record=${esx02_name}.${zone_name},${esx02_ip}
    host-record=${esx03_name}.${zone_name},${esx03_ip}
    host-record=${esx04_name}.${zone_name},${esx04_ip}
    host-record=${vcenter_name}.${zone_name},${vcenter_ip}
    host-record=${nsx_vip_name}.${zone_name},${nsx_vip_ip}
    host-record=${nsx_node_1_name}.${zone_name},${nsx_node_1_ip}
    host-record=${nsx_node_2_name}.${zone_name},${nsx_node_2_ip}
    host-record=${nsx_node_3_name}.${zone_name},${nsx_node_3_ip}
    host-record=${sddc_manager_name}.${zone_name},${sddc_manager_ip}
    host-record=${cloudbuilder_name}.${zone_name},${cloudbuilder_ip}
- path: /etc/chrony/conf.d/vcf.conf
  append: true
  content: |
    allow all
- path: /etc/bird/bird.conf
  append: false
  content: |
    router id ${address};
    protocol kernel {
            learn;
            scan time 60;
            import all;
            export all;
    }
    protocol device {
            scan time 60;
    }
    protocol static {
      route 169.254.255.1/32 via ${gateway_address};
      route 169.254.255.2/32 via ${gateway_address};
    }
    filter metal_bgp {
      if net = 0.0.0.0/0 then accept;
    }
    protocol bgp neighbor_v4_1 {
      export filter metal_bgp;
      import all;
      local as 65101;
      multihop;
      neighbor 169.254.255.1 as 65100;
    }
    protocol bgp neighbor_v4_2 {
      export filter metal_bgp;
      import all;
      local as 65101;
      multihop;
      neighbor 169.254.255.2 as 65100;
    }
packages:
  # python packages are to enable installing esxcli later
  - iptables-persistent
  - dnsmasq
  - chrony
  - jq
  - bird
runcmd:
- sysctl -p /etc/sysctl.d/10-ip-forwarding.conf
- systemctl disable systemd-resolved --now
- DEBIAN_FRONTEND=noninteractive apt-get remove -y systemd-resolved
- rm /etc/resolv.conf
- |
  cat << EOF > /etc/resolv.conf
  nameserver 127.0.0.1
  nameserver 147.75.207.207
  nameserver 147.75.207.208
  nameserver 1.1.1.1
  nameserver 8.8.8.8
  search ${zone_name}
  EOF
- systemctl restart networking
- systemctl restart dnsmasq
